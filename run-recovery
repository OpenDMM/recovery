#!/bin/sh
#
# Copyright (C) 2014 Dream Property GmbH
#

set -e

BASE_URI=http://dreamboxupdate.com/download/recovery/dm7080/release
FILENAME=recovery
DEVICE=/dev/mmcblk0
DATA_PARTITION=${DEVICE}p2
DATA_MOUNTPOINT=/data
RECOVERY_CACHE=${DATA_MOUNTPOINT}/.recovery

cleanup()
{
	[ -z "$TEMP" ] || rm -rf "$TEMP"
	unmount ${DATA_MOUNTPOINT}
}

abort()
{
	echo "Fatal: $@"
	exit 1
}

warn()
{
	echo "Warning: $@"
}

info()
{
	echo "[*] $@"
}

fetch()
{
	info "Downloading ${BASE_URI}/${1}"
	wget -q ${BASE_URI}/${1} -O ${1}
}

verify()
{
	info "Verifying signature of ${1}"
	gpgv -q --ignore-time-conflict ${1}.sig ${1}
}

fetch_signed()
{
	fetch ${1}.sig

	if [ -f "${RECOVERY_CACHE}/${1}" -a -f "${RECOVERY_CACHE}/${1}.sig" ]; then
		if [ ! -f ${1}.sig ] || cmp -s ${1}.sig ${RECOVERY_CACHE}/${1}.sig; then
			info "Copying ${1} from local storage"
			cp ${RECOVERY_CACHE}/${1}.sig ${1}.sig
			cp ${RECOVERY_CACHE}/${1} ${1}
		fi
	fi

	[ -f ${1}.sig ] || abort "Failed to obtain signature '${1}.sig'"
	[ -f ${1} ] && verify ${1} || fetch ${1} || abort "Failed to download '${1}'"

	verify ${1} || abort 'Failed to verify signature'
}

create_directory()
{
	mkdir -p ${1}
}

is_blockdev()
{
	[ -b "${1}" ]
}

is_directory()
{
	[ -d "${1}" ]
}

is_mountpoint()
{
	mountpoint -q ${1}
}

is_writeable()
{
	[ -w "${1}" ]
}

unmount()
{
	if is_mountpoint ${1}; then
		info "Unmounting ${1}"
		umount ${1} || mount -o remount,ro ${1}
	fi
}

mount_cache()
{
	if is_blockdev ${DATA_PARTITION}; then
		create_directory ${DATA_MOUNTPOINT}
		if is_directory ${DATA_MOUNTPOINT}; then
			info "Mounting ${DATA_MOUNTPOINT} (ro)"
			mount -o ro ${DATA_PARTITION} ${DATA_MOUNTPOINT} || warn "Failed to mount data filesystem"
		fi
	fi
}

cache_changed()
{
	is_mountpoint ${DATA_MOUNTPOINT} && ! cmp -s ${RECOVERY_CACHE}/${1}.sig ${1}.sig
}

remount_cache_rw()
{
	is_mountpoint ${DATA_MOUNTPOINT} && info "Remounting ${DATA_MOUNTPOINT} (rw)" && \
		mount -o remount,rw ${DATA_MOUNTPOINT} && is_writeable ${DATA_MOUNTPOINT}
}

update_cache()
{
	if cache_changed ${1} && remount_cache_rw; then
		create_directory ${RECOVERY_CACHE}
		if is_directory ${RECOVERY_CACHE}; then
			info "Updating recovery cache"
			cp ${FILENAME} ${RECOVERY_CACHE}/${FILENAME} || true
			cp ${FILENAME}.sig ${RECOVERY_CACHE}/${FILENAME}.sig || true
		fi
	fi
}

unmount_cache()
{
	unmount ${DATA_MOUNTPOINT}
}

run()
{
	info "Running ${1}"
	chmod 755 ${1} || abort "Failed to set execute permissions"
	${1} || abort "Failed to execute ${1}"
}

umask 077

TEMP=`mktemp -d` || abort 'Failed to create working directory'
trap cleanup EXIT
cd $TEMP || abort 'Failed to change working directory'
export GNUPGHOME=$TEMP

(base64 -d > trustedkeys.gpg || abort 'Failed to write public key') << EOF
mQENBFPo2oUBCAC6dzqe5azBCkxzj99xNfzwB4L6tHzz83zqD2KUQuuJMhO7Q2g9AHnSNQ0z1+Bz
oX2gGX90FusBSLiCuZmNdnxlcl7KVfBe37EpYtQNGCZKlWeruCAUdJGKIyPJXDvkXCy3dj6z1ho8
p1r3uazEbUbJyLvwjzcg0Ua1qxFjLoq/h15yDgd0NCkMStL6gwKdmReLRfE/tn0K53CVQzIeEFyn
EW3N0tu2deiYkanHy/MM9IOIv3oQmoEWNaVsDf+gG7nUPj0QE66GOYlBugR5vNi3BorOctarQp/8
Dh56muiqomwwewJubzsvjUjpiYXdO/3RN2gOej2+5hUCiYmvOahfABEBAAG0LkRyZWFtYm94IERN
NzA4MCBSZWNvdmVyeSA8cmVjb3ZlcnlAZG03MDgwLmNvbT6JATgEEwECACIFAlPo2oUCGwMGCwkI
BwMCBhUIAgkKCwQWAgMBAh4BAheAAAoJEBWob67Wz1bnUGYH/0zmTS7Gtvv97oHHnz3JSkLybDRj
Jx/wH+vpzyCRl8rC7TlHs5GBfjoJ1Hjo4DsZqElTb8g+kg5WGzMBUUuwabRhZuf2CL7/IPKP+LWH
t2ByZX3OgS1Q+HDLob5wlKllD9y/wwekuwS/8cgdnDH9URHCBqIt5gWQzLU1pvmQrKPXM1aMsLQj
16vbktXNkREF/cNhWfQFQs2dOwmzNEDeuE32I6h7PYl1bFP0hCOmbkcTuibnC+tsWOJMKF1iZ8bq
xDND9BYTwGtD2SVrddu3i4kBz6hka01ZnfSUZewpu+TrCgaD6oENfarPiC9VYfKEFi10RIPIxwRX
s1tBOOQNKpywAgAD
EOF

mount_cache
fetch_signed ${FILENAME}

update_cache ${FILENAME}
unmount_cache

run ./${FILENAME}
